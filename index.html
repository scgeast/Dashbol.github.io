<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Monitoring - Upload Excel & Update Interaktif</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<style>
  /* (Gunakan style dari script Anda sebelumnya, disingkat agar fokus ke fungsi) */
  body { font-family: 'Poppins', sans-serif; background: #f5f7fa; color: #333; margin: 0; padding: 20px; }
  .container { max-width: 1200px; margin: auto; }
  header { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
  .header-top { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
  .logo { display: flex; align-items: center; }
  .logo h1 { margin-left: 10px; }
  .date-filter { background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 30px; display: flex; align-items: center; margin-top: 10px; }
  .date-filter i { margin-right: 8px; }
  .header-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
  .stat-card { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center; }
  .stat-card h3 { font-weight: 500; margin-bottom: 8px; }
  .stat-card .value { font-size: 24px; font-weight: 700; }
  .filter-section { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
  .filter-title { display: flex; align-items: center; margin-bottom: 15px; }
  .filter-title h2 { margin-left: 10px; color: #2c3e50; }
  .filter-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
  .filter-group { display: flex; flex-direction: column; }
  .filter-group label { margin-bottom: 5px; font-weight: 500; }
  .filter-group input, .filter-group select { padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
  .filter-buttons { margin-top: 15px; display: flex; gap: 10px; }
  .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; }
  .btn-primary { background-color: #3498db; color: white; }
  .btn-primary:hover { background-color: #2980b9; }
  .btn-secondary { background-color: #ecf0f1; color: #2c3e50; }
  .btn-secondary:hover { background-color: #dde4e6; }
  .update-section { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 15px; background-color: #e8f4fc; border-radius: 8px; flex-wrap: wrap; }
  .last-update { display: flex; align-items: center; margin-bottom: 10px; }
  .last-update i { margin-right: 10px; color: #3498db; }
  .auto-update { display: flex; align-items: center; }
  .switch { position: relative; display: inline-block; width: 50px; height: 24px; margin-left: 10px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
  .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: #2ecc71; }
  input:checked + .slider:before { transform: translateX(26px); }
  .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
  .card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
  .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
  .card-header h2 { font-size: 18px; color: #2c3e50; }
  .card-content { height: 250px; }
  .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
  .data-table th { background-color: #ecf0f1; color: #2c3e50; font-weight: 600; }
  .data-table tr:hover { background-color: #f9f9f9; }
  .status-delivered { color: #2ecc71; font-weight: 500; }
  .status-pending { color: #f39c12; font-weight: 500; }
  .status-cancel { color: #e74c3c; font-weight: 500; }
  .notification {
    position: fixed; bottom: 20px; right: 20px; background-color: #2c3e50; color: white;
    padding: 10px 15px; border-radius: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    opacity: 0; transition: opacity 0.3s ease; z-index: 1000;
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="header-top">
      <div class="logo">
        <i class="fas fa-hard-hat fa-2x"></i>
        <h1>Monitoring Pengiriman Beton</h1>
      </div>
      <div class="date-filter">
        <i class="far fa-calendar-alt"></i>
        <span id="current-date">--</span>
      </div>
    </div>
    <div class="header-stats">
      <div class="stat-card">
        <h3>Total Volume Order</h3>
        <div class="value" id="total-volume">0 m³</div>
      </div>
      <div class="stat-card">
        <h3>Volume Terkirim</h3>
        <div class="value" id="delivered-volume">0 m³</div>
      </div>
      <div class="stat-card">
        <h3>Volume Tertunda</h3>
        <div class="value" id="pending-volume">0 m³</div>
      </div>
      <div class="stat-card">
        <h3>Total Proyek</h3>
        <div class="value" id="total-projects">0</div>
      </div>
    </div>
  </header>

  <div class="filter-section">
    <div class="filter-title">
      <i class="fas fa-filter"></i>
      <h2>Filter Data</h2>
    </div>
    <div class="filter-controls">
      <div class="filter-group">
        <label for="start-date">Dari Tanggal:</label>
        <input type="date" id="start-date" />
      </div>
      <div class="filter-group">
        <label for="end-date">Sampai Tanggal:</label>
        <input type="date" id="end-date" />
      </div>
      <div class="filter-group">
        <label for="plant-filter">Plant:</label>
        <select id="plant-filter">
          <option value="all">Semua Plant</option>
          <option value="denpasar">Denpasar 2</option>
          <option value="gianyar">Gianyar</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="status-filter">Status:</label>
        <select id="status-filter">
          <option value="all">Semua Status</option>
          <option value="delivered">Terkirim</option>
          <option value="pending">Tertunda</option>
          <option value="cancel">Batal</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="excel-upload">Upload Data Excel:</label>
        <input type="file" id="excel-upload" accept=".xlsx,.xls" />
      </div>
    </div>
    <div class="filter-buttons">
      <button class="btn btn-primary" id="apply-filter"><i class="fas fa-check"></i> Terapkan Filter</button>
      <button class="btn btn-secondary" id="reset-filter"><i class="fas fa-sync"></i> Reset Filter</button>
    </div>
    <div class="update-section">
      <div class="last-update">
        <i class="fas fa-clock"></i>
        <span>Terakhir update: <span id="last-update-time">--:--:--</span></span>
      </div>
      <div class="auto-update">
        <span>Auto Update:</span>
        <label class="switch">
          <input type="checkbox" id="auto-update-toggle" />
          <span class="slider"></span>
        </label>
      </div>
    </div>
  </div>

  <div class="dashboard">
    <div class="card">
      <div class="card-header">
        <h2>Status Pengiriman</h2>
        <i class="fas fa-truck-loading"></i>
      </div>
      <div class="card-content">
        <canvas id="statusChart"></canvas>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <h2>Volume per Tanggal</h2>
        <i class="fas fa-chart-line"></i>
      </div>
      <div class="card-content">
        <canvas id="volumeChart"></canvas>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <h2>Performa per Plant</h2>
        <i class="fas fa-industry"></i>
      </div>
      <div class="card-content">
        <canvas id="plantChart"></canvas>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2>Data Pengiriman Terbaru</h2>
      <i class="fas fa-list"></i>
    </div>
    <div style="overflow-x:auto;">
      <table class="data-table">
        <thead>
          <tr>
            <th>Plant</th>
            <th>Tanggal</th>
            <th>Status</th>
            <th>Site No</th>
            <th>Site Name</th>
            <th>Qty Order</th>
            <th>Qty Delivered</th>
            <th>Qty Remain</th>
          </tr>
        </thead>
        <tbody id="delivery-data"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="notification" class="notification"></div>

<script>
  // Data global
  let deliveryData = [];

  // Chart instances
  let statusChart, volumeChart, plantChart;
  let autoUpdateInterval;

  // Format tanggal dd/mm/yyyy ke Date object
  function parseDateString(dateStr) {
    if (!dateStr) return null;
    const parts = dateStr.split('/');
    if (parts.length === 3) {
      return new Date(parts[2], parts[1] - 1, parts[0]);
    }
    return new Date(dateStr);
  }

  // Parsing angka dengan koma desimal
  function parseNumber(value) {
    if (value === '-' || value === '' || value === null || value === undefined) return 0;
    if (typeof value === 'number') return value;
    if (typeof value === 'string') {
      const num = parseFloat(value.replace(',', '.'));
      return isNaN(num) ? 0 : num;
    }
    return 0;
  }

  // Update tanggal sekarang di header
  function updateCurrentDate() {
    const now = new Date();
    const options = { day: '2-digit', month: 'long', year: 'numeric' };
    document.getElementById('current-date').textContent = now.toLocaleDateString('id-ID', options);
  }

  // Update waktu terakhir update
  function updateLastUpdateTime() {
    const now = new Date();
    document.getElementById('last-update-time').textContent = now.toLocaleTimeString('id-ID');
  }

  // Show notification
  function showNotification(message) {
    const notif = document.getElementById('notification');
    notif.textContent = message;
    notif.style.opacity = '1';
    setTimeout(() => { notif.style.opacity = '0'; }, 3000);
  }

  // Render data ke tabel
  function renderDeliveryData(data = deliveryData) {
    const tbody = document.getElementById('delivery-data');
    tbody.innerHTML = '';
    data.forEach(item => {
      let statusClass = '';
      if (item.status.toUpperCase() === 'DELIVERED') statusClass = 'status-delivered';
      else if (item.status.toUpperCase() === 'PENDING') statusClass = 'status-pending';
      else if (item.status.toUpperCase() === 'CANCEL') statusClass = 'status-cancel';

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${item.plant}</td>
        <td>${item.date}</td>
        <td class="${statusClass}">${item.status}</td>
        <td>${item.siteNo}</td>
        <td>${item.siteName}</td>
        <td>${item.qtyOrder}</td>
        <td>${item.qtyDelivered}</td>
        <td>${item.qtyRemain}</td>
      `;
      tbody.appendChild(row);
    });
  }

  // Update summary dan charts
  function updateSummary() {
    let totalVolume = 0, deliveredVolume = 0, pendingVolume = 0, cancelVolume = 0;
    let totalProjects = deliveryData.length;

    deliveryData.forEach(item => {
      totalVolume += item.qtyOrder;
      deliveredVolume += item.qtyDelivered;
      pendingVolume += item.qtyRemain;
      if (item.status.toUpperCase() === 'CANCEL') cancelVolume += item.qtyOrder;
    });

    document.getElementById('total-volume').textContent = `${totalVolume.toFixed(2)} m³`;
    document.getElementById('delivered-volume').textContent = `${deliveredVolume.toFixed(2)} m³`;
    document.getElementById('pending-volume').textContent = `${pendingVolume.toFixed(2)} m³`;
    document.getElementById('total-projects').textContent = totalProjects;

    // Update status chart
    if (statusChart) {
      statusChart.data.datasets[0].data = [deliveredVolume, pendingVolume, cancelVolume];
      statusChart.update();
    }

    // Update plant chart
    const plants = {};
    deliveryData.forEach(item => {
      plants[item.plant] = (plants[item.plant] || 0) + item.qtyOrder;
    });
    if (plantChart) {
      plantChart.data.labels = Object.keys(plants);
      plantChart.data.datasets[0].data = Object.values(plants);
      plantChart.update();
    }

    // Update volume per tanggal chart
    const volumePerDate = {};
    deliveryData.forEach(item => {
      volumePerDate[item.date] = (volumePerDate[item.date] || 0) + item.qtyOrder;
    });
    if (volumeChart) {
      volumeChart.data.labels = Object.keys(volumePerDate);
      volumeChart.data.datasets[0].data = Object.values(volumePerDate);
      volumeChart.update();
    }
  }

  // Inisialisasi chart
  function initCharts() {
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    statusChart = new Chart(statusCtx, {
      type: 'doughnut',
      data: {
        labels: ['Terkirim', 'Tertunda', 'Dibatalkan'],
        datasets: [{
          data: [0, 0, 0],
          backgroundColor: ['#2ecc71', '#f39c12', '#e74c3c'],
          borderWidth: 1
        }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
    });

    const volumeCtx = document.getElementById('volumeChart').getContext('2d');
    volumeChart = new Chart(volumeCtx, {
      type: 'bar',
      data: {
        labels
